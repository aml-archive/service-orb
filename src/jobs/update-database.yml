description: >
  Uses Liquibase to update a database

executor: machine

parameters:
  server:
    type: string
    description: >
      Name of database server
  db-password:
    type: env_var_name
    description: >
      Name of environment variable storing the database password
  change-log-file:
    type: string
    default: ./.circleci/db-changelog.yml
    description: >
      The Liquibase change log file to apply
  resource-group:
    type: string
    default: storage
    description: >
      Azure resource group the database belongs to
  subscription:
    type: enum
    enum: ["Staging", "Production"]
    description: >
      Azure subscription the database belongs to

steps:
  - azure-cli/install
  - azure-cli/login-with-service-principal
  - checkout
  - run:
      name: Add firewall rule
      command: |
        machine_ip=$(wget -qO- http://checkip.amazonaws.com)
        az sql server firewall-rule create \
          --name CircleCI \
          --resource-group << parameters.resource-group >> \
          --subscription << parameters.subscription >> \
          --server << parameters.server >> \
          --start-ip-address $machine_ip --end-ip-address $machine_ip
  - run:
      name: Update database
      command: |
        docker run -v $PWD:/liquibase/changelog liquibase/liquibase \
          --url="jdbc:sqlserver://<< parameters.server >>.database.windows.net:1433;database=avid;" \
          --username=app@avid@<< parameters.server >> \
          --password=$<< parameters.db-password >> \
          --changeLogFile=<< parameters.change-log-file >> \
          update
  - run:
      name: Delete firewall rule
      command: |
        public_ip=$(wget -qO- http://checkip.amazonaws.com)
        az sql server firewall-rule delete \
          --name CircleCI \
          --resource-group << parameters.resource-group >> \
          --subscription << parameters.subscription >> \
          --server << parameters.server >>
      when: always
